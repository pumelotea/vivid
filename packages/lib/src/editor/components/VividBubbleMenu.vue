<script setup>
import VividMenuItem from '../../core/components/VividMenuItem.vue'
import {useThemeVars} from 'naive-ui'
import VividColorPicker from '../../core/components/VividColorPicker.vue'
import VividLinkModal from '../../core/extension/link/VividLinkModal.vue'
import VividImageModal from '../../core/extension/image/VividImageModal.vue'
import VividVideoModal from '../../core/extension/video/VividVideoModal.vue'
import {ref, watch} from 'vue'

const vars = useThemeVars()
const props = defineProps({
	editor: {
		type: Object,
		required: true
	}
})

function insertTable(r, c) {
	props.editor.chain().focus().insertTable({rows: r, cols: c, withHeaderRow: true}).run()
}

const color = ref('#000000')

function setColor() {
	props.editor.chain().focus().setColor(color.value).run()
}

function updateColor(e) {
	color.value = e
	setColor()
}

const colorHighlight = ref('#fec300')

function setHighlightColor() {
	props.editor.chain().focus().toggleHighlight({color: colorHighlight.value}).run()
}

function updateHeightColor(e) {
	colorHighlight.value = e
	props.editor.chain().focus().setHighlight({color: colorHighlight.value}).run()
}

const HTL = ref(null)

function handleOpenLink() {
	if (props.editor.isActive('link')) {
		props.editor.chain().focus().unsetLink().run()
	} else {
		HTL.value.open()
	}
}

function toggleLink(href, target) {
	props.editor.chain().focus().toggleLink({href, target}).run()
}

const HTI = ref(null)

function handleOpenImage() {
	HTI.value.open()
}

function insertImage(url) {
	if (url) {
		props.editor.chain().focus().setHbImage({src: url}).run()
	}
}

const HTV = ref(null)

function handleOpenVideo() {
	HTV.value.open()
}

function insertVideo(url) {
	if (url) {
		props.editor.chain().focus().setHbVideo({src: url}).run()
	}
}

function toggleFullscreen() {
	props.editor.storage.fullscreen.value = !props.editor.storage.fullscreen.value
}

</script>
<template>
	<div class="bubble-menu-bar">
		<vivid-menu-item
			icon="format-clear"
			title="清除样式"
			:action="() => props.editor.chain().focus().clearNodes().unsetAllMarks().run()"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="bold"
			title="加粗"
			:action="() => props.editor.chain().focus().toggleBold().run()"
			:is-active="() => props.editor.isActive('bold')"
		/>
		<vivid-menu-item
			icon="italic"
			title="斜体"
			:action="() => props.editor.chain().focus().toggleItalic().run()"
			:is-active="() => props.editor.isActive('italic')"
		/>
		<vivid-menu-item
			icon="underline"
			title="下划线"
			:action="() => props.editor.chain().focus().toggleUnderline().run()"
			:is-active="() => props.editor.isActive('underline')"
		/>
		<vivid-menu-item
			icon="strikethrough"
			title="文本线"
			:action="() => props.editor.chain().focus().toggleStrike().run()"
			:is-active="() => props.editor.isActive('strike')"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="mark-pen-line"
			title="高亮"
			:action="setHighlightColor"
			:is-active="() => props.editor.isActive('highlight')"
		/>
		<vivid-color-picker
			:default-color="colorHighlight"
			@change="updateHeightColor"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="font-color"
			title="字体颜色"
			:action="setColor"
			:is-active="() => props.editor.isActive('font-color')"
		/>
		<vivid-color-picker @change="updateColor"/>
		<div class="divider"/>
		<vivid-menu-item
			icon="align-left"
			title="左对齐"
			:action="() => props.editor.chain().focus().setTextAlign('left').run()"
			:is-active="() => props.editor.isActive('align-left')"
		/>
		<vivid-menu-item
			icon="align-center"
			title="居中"
			:action="() => props.editor.chain().focus().setTextAlign('center').run()"
			:is-active="() => props.editor.isActive('align-center')"
		/>
		<vivid-menu-item
			icon="align-right"
			title="右对齐"
			:action="() => props.editor.chain().focus().setTextAlign('right').run()"
			:is-active="() => props.editor.isActive('align-right')"
		/>
		<vivid-menu-item
			icon="align-justify"
			title="两端对齐"
			:action="() => props.editor.chain().focus().setTextAlign('justify').run()"
			:is-active="() => props.editor.isActive('align-justify')"
		/>
		<vivid-menu-item
			icon="subscript"
			title="上角标"
			:action="() => props.editor.chain().focus().toggleSubscript().run()"
			:is-active="() => props.editor.isActive('subscript')"
		/>
		<vivid-menu-item
			icon="superscript"
			title="下角标"
			:action="() => props.editor.chain().focus().toggleSuperscript().run()"
			:is-active="() => props.editor.isActive('superscript')"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="h-1"
			title="标题1"
			:action="() => props.editor.chain().focus().toggleHeading({level: 1}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 1})"
		/>
		<vivid-menu-item
			icon="h-2"
			title="标题2"
			:action="() => props.editor.chain().focus().toggleHeading({level: 2}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 2})"
		/>
		<vivid-menu-item
			icon="h-3"
			title="标题3"
			:action="() => props.editor.chain().focus().toggleHeading({level: 3}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 3})"
		/>
		<vivid-menu-item
			icon="h-4"
			title="标题4"
			:action="() => props.editor.chain().focus().toggleHeading({level: 4}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 4})"
		/>
		<vivid-menu-item
			icon="h-5"
			title="标题5"
			:action="() => props.editor.chain().focus().toggleHeading({level: 5}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 5})"
		/>
		<vivid-menu-item
			icon="h-6"
			title="标题6"
			:action="() => props.editor.chain().focus().toggleHeading({level: 6}).run()"
			:is-active="() => props.editor.isActive('heading', {level: 6})"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="list-unordered"
			title="无序列表"
			:action="() => props.editor.chain().focus().toggleBulletList().run()"
			:is-active="() => props.editor.isActive('bulletList')"
		/>
		<vivid-menu-item
			icon="list-ordered"
			title="有序列表"
			:action="() => props.editor.chain().focus().toggleOrderedList().run()"
			:is-active="() => props.editor.isActive('orderedList')"
		/>
		<vivid-menu-item
			icon="task-line"
			title="任务列表"
			:action="() => props.editor.chain().focus().toggleTaskList().run()"
			:is-active="() => props.editor.isActive('taskList')"
		/>
		<vivid-menu-item
			icon="double-quotes-l"
			title="引用"
			:action="() => props.editor.chain().focus().toggleBlockquote().run()"
			:is-active="() => props.editor.isActive('blockquote')"
		/>
		<div class="divider"/>
		<vivid-menu-item
			icon="link"
			title="超链接"
			:action="handleOpenLink"
			:is-active="() => props.editor.isActive('link')"
		/>
		<vivid-link-modal
			ref="HTL"
			@ok="toggleLink"
		/>
		<vivid-menu-item
			icon="image-line"
			title="插入图片"
			:action="handleOpenImage"
			:is-active="() => props.editor.isActive('hb-image')"
		/>
		<vivid-image-modal
			ref="HTI"
			@ok="insertImage"
		/>
		<vivid-menu-item
			icon="video-line"
			title="插入视频"
			:action="handleOpenVideo"
			:is-active="() => props.editor.isActive('hb-video')"
		/>
		<vivid-video-modal
			ref="HTV"
			@ok="insertVideo"
		/>
		<vivid-menu-item
			icon="brackets-line"
			title="代码"
			:action="() => props.editor.chain().focus().toggleCode().run()"
			:is-active="() => props.editor.isActive('code')"
		/>
		<vivid-menu-item
			icon="code-view"
			title="代码"
			:action="() => props.editor.chain().focus().toggleCodeBlock().run()"
			:is-active="() => props.editor.isActive('hb-code')"
		/>
		<template v-if="props.editor.isActive('table')">
			<div class="divider"/>
			<vivid-menu-item
				icon="delete-bin-6-line"
				title="删除表格"
				:action="() => props.editor.chain().focus().deleteTable().run()"
			/>
			<vivid-menu-item
				icon="merge-cells-horizontal"
				title="合并拆分单元格"
				:action="() => props.editor.chain().focus().mergeOrSplit().run()"
			/>
			<vivid-menu-item
				icon="insert-row-top"
				title="上面添加一行"
				:action="() => props.editor.chain().focus().addRowBefore().run()"
			/>
			<vivid-menu-item
				icon="insert-row-bottom"
				title="下面添加一行"
				:action="() => props.editor.chain().focus().addRowAfter().run()"
			/>
			<vivid-menu-item
				icon="delete-row"
				title="删除行"
				:action="() => props.editor.chain().focus().deleteRow().run()"
			/>
			<vivid-menu-item
				icon="insert-column-left"
				title="左边添加一列"
				:action="() => props.editor.chain().focus().addColumnBefore().run()"
			/>
			<vivid-menu-item
				icon="insert-column-right"
				title="右边添加一列"
				:action="() => props.editor.chain().focus().addColumnAfter().run()"
			/>
			<vivid-menu-item
				icon="delete-column"
				title="删除行"
				:action="() => props.editor.chain().focus().deleteColumn().run()"
			/>
		</template>
	</div>
</template>

<style scoped>
.bubble-menu-bar {
	display: flex;
	align-items: center;
	flex-wrap: wrap;
	padding: 5px 5px;
	background: v-bind(vars.popoverColor);
	border-radius: 3px;
	box-shadow: v-bind(vars.boxShadow2);
}

.divider {
	width: 2px;
	height: 20px;
	background-color: v-bind(vars.borderColor);
	margin-left: 2px;
	margin-right: 2px;
}
</style>
